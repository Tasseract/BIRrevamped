<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Register Business - BIR eServices</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .form-section {
      margin-bottom: 28px;
      padding: 20px;
      background: rgba(11, 18, 32, 0.02);
      border-radius: 8px;
    }
    .form-section h3 {
      margin-bottom: 16px;
      font-size: 1rem;
      color: #081224;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    .form-grid.full {
      grid-template-columns: 1fr;
    }
    .input-group {
      display: flex;
      flex-direction: column;
    }
    .input-group label {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 6px;
      color: #081224;
    }
    .input-group input,
    .input-group select,
    .input-group textarea {
      padding: 10px 12px;
      border: 1px solid #e1e7ed;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.95rem;
      transition: border-color 0.2s;
    }
    .input-group input:focus,
    .input-group select:focus,
    .input-group textarea:focus {
      outline: none;
      border-color: #0b1220;
      box-shadow: 0 0 0 3px rgba(11, 18, 32, 0.06);
    }
    .input-group textarea {
      min-height: 80px;
      resize: vertical;
    }
    .input-group .required-note {
      font-size: 0.8rem;
      color: #e63946;
      margin-top: 4px;
    }
    .status-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    .status-message.pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffc107;
      display: block;
    }
    .status-message.approved {
      background: #d4edda;
      color: #155724;
      border: 1px solid #28a745;
      display: block;
    }
    .status-message.rejected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    .button-group {
      display: flex;
      gap: 12px;
      margin-top: 28px;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a class="logo" href="index.html">BIR eServices</a>
      <div style="flex:1"></div>
      <div class="user-profile" id="reg-user-profile">
        <button id="reg-logout" class="logout-btn">Log Out</button>
      </div>
    </nav>
  </header>

  <main style="max-width:900px;margin:48px auto;padding:0 24px;">
    <section class="card" style="padding:28px;border-radius:14px;background:var(--card);box-shadow:0 8px 24px rgba(12,18,30,0.04);">
      <h1>Register Your Business</h1>
      <p class="muted" style="margin-top:8px;">Complete this form to register your business with the Bureau of Internal Revenue (BIR). All fields marked with * are required.</p>

      <div id="status-container"></div>

      <form id="register-business-form">
        <!-- Business Information -->
        <div class="form-section">
          <h3>üìã Business Information</h3>
          <div class="form-grid">
            <div class="input-group">
              <label for="businessName">Business Name <span style="color:#e63946;">*</span></label>
              <input type="text" id="businessName" name="businessName" required placeholder="Enter your business name">
              <span class="required-note">As registered with BIR</span>
            </div>
            <div class="input-group">
              <label for="businessTin">Business TIN <span style="color:#e63946;">*</span></label>
              <input type="text" id="businessTin" name="businessTin" required placeholder="e.g., 123-456-789-000">
              <span class="required-note">Tax Identification Number</span>
            </div>
          </div>
          <div class="form-grid full" style="margin-top:16px;">
            <div class="input-group">
              <label for="businessType">Business Type <span style="color:#e63946;">*</span></label>
              <select id="businessType" name="businessType" required>
                <option value="">Select Business Type</option>
                <option value="Sole Proprietorship">Sole Proprietorship</option>
                <option value="Partnership">Partnership</option>
                <option value="Corporation">Corporation</option>
                <option value="Cooperative">Cooperative</option>
                <option value="Non-Stock, Non-Profit">Non-Stock, Non-Profit</option>
              </select>
            </div>
          </div>
          <div class="form-grid full" style="margin-top:16px;">
            <div class="input-group">
              <label for="businessAddress">Business Address <span style="color:#e63946;">*</span></label>
              <textarea id="businessAddress" name="businessAddress" required placeholder="Full business address (Street, Barangay, City/Municipality, Province, Postal Code)"></textarea>
            </div>
          </div>
          <div class="form-grid" style="margin-top:16px;">
            <div class="input-group">
              <label for="businessContact">Contact Number <span style="color:#e63946;">*</span></label>
              <input type="tel" id="businessContact" name="businessContact" required placeholder="e.g., +63-2-1234-5678">
            </div>
            <div class="input-group">
              <label for="businessEmail">Business Email</label>
              <input type="email" id="businessEmail" name="businessEmail" placeholder="e.g., info@business.com">
            </div>
          </div>
          <div class="form-grid full" style="margin-top:16px;">
            <div class="input-group">
              <label for="businessRegNum">BIR Registration Number</label>
              <input type="text" id="businessRegNum" name="businessRegNum" placeholder="Optional: If already registered with BIR">
            </div>
          </div>
        </div>

        <!-- Owner Information -->
        <div class="form-section">
          <h3>üë§ Owner Information</h3>
          <div class="form-grid">
            <div class="input-group">
              <label for="ownerName">Full Name <span style="color:#e63946;">*</span></label>
              <input type="text" id="ownerName" name="ownerName" required placeholder="First Name, Middle Name, Last Name">
              <span class="required-note">As shown in government ID</span>
            </div>
            <div class="input-group">
              <label for="ownerTin">Personal TIN <span style="color:#e63946;">*</span></label>
              <input type="text" id="ownerTin" name="ownerTin" required placeholder="e.g., 123-456-789-000">
              <span class="required-note">Your Tax Identification Number</span>
            </div>
          </div>
        </div>

        <!-- Terms & Submit -->
        <div style="margin-top:28px;">
          <label style="display:flex;align-items:center;gap:8px;font-size:0.95rem;cursor:pointer;">
            <input type="checkbox" id="terms-agree" required style="width:18px;height:18px;cursor:pointer;">
            <span>I certify that the information provided is accurate and complete as required by the Bureau of Internal Revenue.</span>
          </label>
        </div>

        <div class="button-group">
          <a href="dashboard.html" class="signup-btn" style="text-decoration:none;display:flex;align-items:center;">Cancel</a>
          <button type="submit" class="auth-button">Submit Registration</button>
        </div>
      </form>
    </section>
  </main>

  <script src="api-config.js"></script>
  <script>
    // Auth guard
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      window.location.href = 'login.html';
    }

    // Logout handler
    const logoutBtn = document.getElementById('reg-logout');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('user');
        window.location.href = 'index.html';
      });
    }

    // Ensure API_BASE is available (from api-config.js)
    if (typeof API_BASE === 'undefined') {
      // fallback to localhost
      var API_BASE = 'http://localhost:3000';
    }

    // Check current registration status
    async function checkRegistrationStatus() {
      try {
        const res = await fetch(`${API_BASE}/businesses?ownerId=${user.id}`);
        const data = await res.json();
        const businesses = data.businesses || [];
        
        if (businesses.length > 0) {
          const latestBusiness = businesses[0];
          const statusContainer = document.getElementById('status-container');
          
          if (latestBusiness.status === 'PENDING') {
            statusContainer.innerHTML = `
              <div class="status-message pending">
                <strong>‚è≥ Pending Approval</strong><br>
                Your business registration is awaiting admin approval. You will be notified once it is reviewed.
              </div>
            `;
            document.getElementById('register-business-form').style.display = 'none';
          } else if (latestBusiness.status === 'APPROVED') {
            statusContainer.innerHTML = `
              <div class="status-message approved">
                <strong>‚úì Approved</strong><br>
                Your business registration has been approved! You can now access all tools.
              </div>
            `;
            document.getElementById('register-business-form').style.display = 'none';
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 2000);
          } else if (latestBusiness.status === 'REJECTED') {
            statusContainer.innerHTML = `
              <div class="status-message rejected">
                <strong>‚úó Rejected</strong><br>
                Your business registration was rejected. Please review the information and try again.
              </div>
            `;
          }
        }
      } catch (err) {
        console.error('Error checking registration status:', err);
      }
    }

    checkRegistrationStatus();

    // Form submission handler
    const registerForm = document.getElementById('register-business-form');
    if (registerForm) {
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const payload = {
          businessName: document.getElementById('businessName').value.trim(),
          businessTin: document.getElementById('businessTin').value.trim(),
          ownerName: document.getElementById('ownerName').value.trim(),
          ownerTin: document.getElementById('ownerTin').value.trim(),
          businessType: document.getElementById('businessType').value.trim(),
          businessAddress: document.getElementById('businessAddress').value.trim(),
          businessContact: document.getElementById('businessContact').value.trim(),
          businessEmail: document.getElementById('businessEmail').value.trim() || null,
          businessRegNum: document.getElementById('businessRegNum').value.trim() || null,
          ownerId: user.id
        };

        try {
          console.log('Submitting payload:', payload);
          const res = await fetch(`${API_BASE}/business/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const body = await res.json();
          console.log('Server response:', { status: res.status, body });
          
          if (!res.ok) {
            const errorMsg = body.message || body.details || 'Registration failed';
            console.error('Registration error:', errorMsg);
            alert(errorMsg);
            return;
          }

          alert('Business registered successfully! Your registration is pending admin approval. Please wait for approval notification.');
          checkRegistrationStatus();
        } catch (err) {
          console.error('Network/Fetch error:', err);
          alert('Error registering business: ' + err.message);
        }
      });
    }
  </script>
</body>
</html>