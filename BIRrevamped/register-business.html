<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Register Business - BIR eServices</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .status-container {
      margin-bottom: 20px;
      min-height: 20px;
    }
    .status-message {
      padding: 15px;
      border-radius: 5px;
      font-size: 14px;
      line-height: 1.5;
    }
    .status-message.pending {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffc107;
    }
    .status-message.approved {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #28a745;
    }
    .status-message.rejected {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .form-group input:invalid,
    .form-group input.error {
      border-color: #e63946 !important;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <a href="index.html">BIR eServices</a>
      </div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">Dashboard</a>
        </li>
        <li class="nav-item">
          <button id="reg-logout" class="nav-link" style="background:none;border:none;cursor:pointer;">Logout</button>
        </li>
      </ul>
    </div>
  </nav>

  <main class="auth-container">
    <section class="auth-box" style="max-width: 600px;">
      <h1>Register Business</h1>
      <p class="muted" style="margin-bottom: 24px;">Complete your business registration to access BIR tools and services.</p>

      <div id="status-container" class="status-container"></div>

      <form id="register-business-form">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="input-group">
            <label for="businessName">Business Name *</label>
            <input type="text" id="businessName" name="businessName" placeholder="Enter your business name" required>
            </div>

            <div class="input-group">
            <label for="businessTin">Business TIN *</label>
            <input type="text" id="businessTin" name="businessTin" placeholder="Enter TIN" required>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="input-group">
            <label for="ownerName">Owner Name *</label>
            <input type="text" id="ownerName" name="ownerName" placeholder="Enter owner name" required>
            </div>

            <div class="input-group">
            <label for="ownerTin">Owner TIN *</label>
            <input type="text" id="ownerTin" name="ownerTin" placeholder="Enter owner TIN" required>
            </div>
        </div>

        <div class="input-group">
          <label for="businessType">Business Type</label>
          <input type="text" id="businessType" name="businessType" placeholder="e.g., Corporation, Partnership">
        </div>

        <div class="input-group">
          <label for="businessAddress">Business Address</label>
          <input type="text" id="businessAddress" name="businessAddress" placeholder="Enter business address">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="input-group">
            <label for="businessContact">Business Contact</label>
            <input type="tel" id="businessContact" name="businessContact" placeholder="Enter contact number">
            </div>

            <div class="input-group">
            <label for="businessEmail">Business Email</label>
            <input type="email" id="businessEmail" name="businessEmail" placeholder="Enter email address">
            </div>
        </div>

        <div class="input-group">
          <label for="businessRegNum">Business Registration Number</label>
          <input type="text" id="businessRegNum" name="businessRegNum" placeholder="Enter registration number">
        </div>

        <div class="button-group" style="display: flex; gap: 12px; margin-top: 24px; align-items: center;">
          <a href="dashboard.html" class="signup-btn" style="text-decoration:none; display:flex; align-items:center; justify-content: center; height: 50px; box-sizing: border-box;">Cancel</a>
          <button type="submit" class="auth-button" style="margin-top: 0; flex: 1;">Submit Registration</button>
        </div>
      </form>
    </section>
  </main>

  <script src="api-config.js"></script>
  <script>
    // Ensure API_BASE is defined
    if (typeof API_BASE === 'undefined') {
      console.error('API_BASE is not defined. Check api-config.js');
      alert('Configuration error: API_BASE is missing. Please check the console.');
    }

    // Auth guard
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      window.location.href = 'login.html';
    }

    // Logout handler
    const logoutBtn = document.getElementById('reg-logout');
    if (logoutBtn) {
      logoutBtn.addEventListener('click', () => {
        localStorage.removeItem('user');
        window.location.href = 'index.html';
      });
    }

    // Helpers for UI status
    function showStatus(type, message) {
      const statusContainer = document.getElementById('status-container');
      const cls = type === 'pending' ? 'status-message pending' : type === 'approved' ? 'status-message approved' : 'status-message rejected';
      statusContainer.innerHTML = `<div class="${cls}">${message}</div>`;
    }

    function clearStatus() {
      document.getElementById('status-container').innerHTML = '';
    }

    // Check registration status for current user
    async function checkRegistrationStatus() {
      if (typeof API_BASE === 'undefined') return;
      try {
        const res = await fetch(`${API_BASE}/businesses?ownerId=${user.id}`);
        const data = await res.json();
        const businesses = data.businesses || [];
        
        if (businesses.length > 0) {
          const latestBusiness = businesses[0];
          
          if (latestBusiness.status === 'PENDING') {
            showStatus('pending', '<strong>⏳ Pending Approval</strong><br>Your business registration is awaiting admin approval. You will be notified once it is reviewed.');
            document.getElementById('register-business-form').style.display = 'none';
          } else if (latestBusiness.status === 'APPROVED') {
            showStatus('approved', '<strong>✓ Approved</strong><br>Your business registration has been approved! You can now access all tools. Redirecting...');
            document.getElementById('register-business-form').style.display = 'none';
            setTimeout(() => {
              window.location.href = 'dashboard.html';
            }, 2000);
          } else if (latestBusiness.status === 'REJECTED') {
            showStatus('rejected', '<strong>✗ Rejected</strong><br>Your business registration was rejected. Please review the information and try again.');
          }
        }
      } catch (err) {
        console.error('Error checking registration status:', err);
        showStatus('rejected', 'Unable to check registration status. Please try again later.');
      }
    }

    // Initial status check
    checkRegistrationStatus();

    // Form submission handler
    const registerForm = document.getElementById('register-business-form');
    if (registerForm) {
      registerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        e.stopPropagation(); // Stop event bubbling
        console.log('Form submission intercepted');

        if (typeof API_BASE === 'undefined') {
             showStatus('rejected', '<strong>System Error:</strong> API configuration missing. Please refresh.');
             return;
        }

        const payload = {
          businessName: document.getElementById('businessName').value.trim(),
          businessTin: document.getElementById('businessTin').value.trim(),
          ownerName: document.getElementById('ownerName').value.trim(),
          ownerTin: document.getElementById('ownerTin').value.trim(),
          businessType: document.getElementById('businessType').value.trim(),
          businessAddress: document.getElementById('businessAddress').value.trim(),
          businessContact: document.getElementById('businessContact').value.trim(),
          businessEmail: document.getElementById('businessEmail').value.trim() || null,
          businessRegNum: document.getElementById('businessRegNum').value.trim() || null,
          ownerId: user.id
        };

        // Client-side validation for required fields
        const requiredFields = [
          { id: 'businessName', label: 'Business Name' },
          { id: 'businessTin', label: 'Business TIN' },
          { id: 'ownerName', label: 'Owner Name' },
          { id: 'ownerTin', label: 'Owner TIN' }
        ];

        const missing = requiredFields.filter(f => !payload[f.id] || payload[f.id].length === 0).map(f => f.label);

        // Clear previous highlights
        requiredFields.forEach(f => document.getElementById(f.id).style.borderColor = '');

        if (missing.length) {
          // Highlight missing fields
          requiredFields.forEach(f => {
            if (missing.includes(f.label)) {
              document.getElementById(f.id).style.borderColor = '#e63946';
            }
          });
          showStatus('rejected', `<strong>Missing required fields:</strong> ${missing.join(', ')}`);
          return;
        }

        // Disable submit button to prevent double-posts
        const submitBtn = registerForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Submitting...';
        clearStatus();

        try {
          console.log('Submitting payload:', payload);
          if (typeof API_BASE === 'undefined') throw new Error('API_BASE is not defined');
          
          const res = await fetch(`${API_BASE}/business/register`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
          });
          const body = await res.json().catch(() => ({}));
          console.log('Server response:', { status: res.status, body });

          if (!res.ok) {
            const errorMsg = body.message || body.details || 'Registration failed';
            console.error('Registration error:', errorMsg);
            showStatus('rejected', `<strong>Error:</strong> ${errorMsg}`);
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
            return;
          }

          showStatus('pending', '<strong>✔ Business registered successfully!</strong><br>Your registration is pending admin approval. You will be notified once it is reviewed.');
          // Hide form after success
          document.getElementById('register-business-form').style.display = 'none';
          // Refresh status from server
          setTimeout(checkRegistrationStatus, 1000);
        } catch (err) {
          console.error('Network/Fetch error:', err);
          showStatus('rejected', `<strong>Network error:</strong> ${err.message || err}`);
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    }
  </script>
</body>
</html>