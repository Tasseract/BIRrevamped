<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Register Business - BIR eServices</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .status-container {
      margin-bottom: 20px;
      min-height: 20px;
    }
    .status-message {
      padding: 15px;
      border-radius: 5px;
      font-size: 14px;
      line-height: 1.5;
    }
    .status-message.pending {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffc107;
    }
    .status-message.approved {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #28a745;
    }
    .status-message.rejected {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .form-group input:invalid,
    .form-group input.error {
      border-color: #e63946 !important;
    }
    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-top: 20px;
        margin-bottom: 10px;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }
    .hidden {
        display: none;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <div class="nav-logo">
        <a href="dashboard.html" class="logo">
            <img src="assets/logo-icon.svg" alt="BIR" class="logo-icon">
            <img src="assets/logo-text.svg" alt="eServices" class="logo-text">
        </a>
      </div>
      <ul class="nav-menu">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">Dashboard</a>
        </li>
        <li class="nav-item">
          <button id="reg-logout" class="nav-link" style="background:none;border:none;cursor:pointer;">Logout</button>
        </li>
      </ul>
    </div>
  </nav>

  <main class="auth-container business-reg-wrapper">
    <section class="auth-box business-reg-box">
      <h1>Register Business</h1>
      <p class="muted" style="margin-bottom: 24px;">Complete your business registration to access BIR tools and services.</p>

      <div id="status-container" class="status-container"></div>

      <form id="register-business-form">
        
        <!-- Registration Type Selection -->
        <div class="input-group">
            <label for="registrationType">Registration Type *</label>
            <select id="registrationType" name="registrationType">
                <option value="INDIVIDUAL">Individual (Sole Proprietorship / Professional)</option>
                <option value="NON_INDIVIDUAL">Non-Individual (Corporation / Partnership)</option>
            </select>
        </div>

        <!-- Common Fields -->
        <div class="section-title">Business Information</div>
        
        <div class="form-grid-row">
            <div class="input-group">
                <label for="businessName">Business Name / Trade Name *</label>
                <input type="text" id="businessName" name="businessName" placeholder="Enter registered business name" required>
            </div>

            <div class="input-group">
                <label for="businessTin">Business TIN *</label>
                <input type="text" id="businessTin" name="businessTin" placeholder="Enter Business TIN" required>
            </div>
        </div>

        <div class="input-group">
            <label for="lineOfBusiness">Line of Business (PSIC) *</label>
            <input type="text" id="lineOfBusiness" name="lineOfBusiness" placeholder="e.g., Retail, IT Services" required>
        </div>

        <div class="input-group">
            <label for="businessAddress">Registered Address *</label>
            <input type="text" id="businessAddress" name="businessAddress" placeholder="Enter complete business address" required>
        </div>

        <div class="form-grid-row">
            <div class="input-group">
                <label for="businessEmail">Business Email Address *</label>
                <input type="email" id="businessEmail" name="businessEmail" placeholder="email@business.com" required>
            </div>
            <div class="input-group">
                <label for="businessContact">Contact Number *</label>
                <input type="text" id="businessContact" name="businessContact" placeholder="Mobile or Landline" required>
            </div>
        </div>

        <!-- Individual Specific Fields -->
        <div id="individual-fields">
            <div class="section-title">Owner Information</div>
            <div class="form-grid-row">
                <div class="input-group">
                    <label for="ownerName">Owner's Full Name *</label>
                    <input type="text" id="ownerName" name="ownerName" placeholder="Last Name, First Name, MI">
                </div>
                <div class="input-group">
                    <label for="ownerTin">Owner's TIN *</label>
                    <input type="text" id="ownerTin" name="ownerTin" placeholder="Enter Owner TIN">
                </div>
            </div>
            <div class="form-grid-row-3">
                <div class="input-group">
                    <label for="dateOfBirth">Date of Birth</label>
                    <input type="date" id="dateOfBirth" name="dateOfBirth">
                </div>
                <div class="input-group">
                    <label for="civilStatus">Civil Status</label>
                    <select id="civilStatus" name="civilStatus">
                        <option value="">Select...</option>
                        <option value="Single">Single</option>
                        <option value="Married">Married</option>
                        <option value="Widowed">Widowed</option>
                        <option value="Separated">Separated</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="citizenship">Citizenship</label>
                    <input type="text" id="citizenship" name="citizenship" placeholder="e.g., Filipino">
                </div>
            </div>
        </div>

        <!-- Non-Individual Specific Fields -->
        <div id="non-individual-fields" class="hidden">
            <div class="section-title">Organization Details</div>
            <div class="form-grid-row">
                <div class="input-group">
                    <label for="organizationType">Organization Type *</label>
                    <select id="organizationType" name="organizationType">
                        <option value="">Select...</option>
                        <option value="Corporation">Corporation</option>
                        <option value="Partnership">Partnership</option>
                        <option value="Cooperative">Cooperative</option>
                        <option value="Association">Association</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="secRegNum">SEC / CDA Registration No. *</label>
                    <input type="text" id="secRegNum" name="secRegNum" placeholder="Enter Registration Number">
                </div>
            </div>
            <div class="form-grid-row">
                <div class="input-group">
                    <label for="dateOfRegistration">Date of Registration</label>
                    <input type="date" id="dateOfRegistration" name="dateOfRegistration">
                </div>
                <div class="input-group">
                    <label for="authorizedRep">Authorized Representative *</label>
                    <input type="text" id="authorizedRep" name="authorizedRep" placeholder="Full Name of Rep">
                </div>
            </div>
        </div>

        <button type="submit" class="auth-button" style="margin-top: 24px;">Submit Registration</button>
      </form>
    </section>
  </main>

  <script src="api-config.js"></script>
  <script src="loader.js"></script>
  <script>
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user) window.location.href = "login.html";

    document.getElementById("reg-logout").addEventListener("click", () => {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    });

    // Toggle fields based on type
    const regTypeSelect = document.getElementById("registrationType");
    const individualFields = document.getElementById("individual-fields");
    const nonIndividualFields = document.getElementById("non-individual-fields");

    regTypeSelect.addEventListener("change", () => {
        if (regTypeSelect.value === "INDIVIDUAL") {
            individualFields.classList.remove("hidden");
            nonIndividualFields.classList.add("hidden");
            
            // Set required attributes
            document.getElementById("ownerName").required = true;
            document.getElementById("ownerTin").required = true;
            document.getElementById("organizationType").required = false;
            document.getElementById("secRegNum").required = false;
            document.getElementById("authorizedRep").required = false;
        } else {
            individualFields.classList.add("hidden");
            nonIndividualFields.classList.remove("hidden");

            // Set required attributes
            document.getElementById("ownerName").required = false;
            document.getElementById("ownerTin").required = false;
            document.getElementById("organizationType").required = true;
            document.getElementById("secRegNum").required = true;
            document.getElementById("authorizedRep").required = true;
        }
    });

    // Initial check
    regTypeSelect.dispatchEvent(new Event("change"));

    // Check existing status
    async function checkStatus() {
      try {
        const res = await fetch(`${API_BASE}/businesses?ownerId=${user.id}`);
        const data = await res.json();
        const businesses = data.businesses || [];
        const container = document.getElementById("status-container");
        
        if (businesses.length > 0) {
            let html = '<div class="status-message approved"><strong>Your Registered Businesses:</strong><ul style="margin-top:5px;padding-left:20px;">';
            businesses.forEach(b => {
                let statusIcon = b.status === 'APPROVED' ? '✅' : (b.status === 'REJECTED' ? '❌' : '⏳');
                html += `<li>${statusIcon} <strong>${b.businessName}</strong> (${b.status})</li>`;
            });
            html += '</ul><div style="margin-top:10px;font-size:0.9em;">You can register another business below.</div></div>';
            container.innerHTML = html;
        }
      } catch (err) {
        console.error(err);
      }
    }
    checkStatus();

    document.getElementById("register-business-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      
      // Add ownerId
      data.ownerId = user.id;

      try {
        const res = await fetch(`${API_BASE}/business/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        const result = await res.json();

        if (res.ok) {
          alert("Registration submitted successfully!");
          window.location.href = "dashboard.html";
        } else {
          alert(result.message || "Registration failed");
        }
      } catch (error) {
        console.error(error);
        alert("An error occurred. Please try again.");
      }
    });
  </script>
</body>
</html>
