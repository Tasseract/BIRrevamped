<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Transactions - BIR eServices</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://unpkg.com/html2pdf.js@0.9.3/dist/html2pdf.bundle.min.js"></script>
</head>
<body>
  <header>
    <nav>
      <a class="logo" href="index.html">
        <img src="assets/logo-icon.svg" alt="BIR" class="logo-icon">
        <img src="assets/logo-text.svg" alt="eServices" class="logo-text">
      </a>
    </nav>
  </header>
  <main style="max-width:900px;margin:48px auto;padding:0 24px;">
    <section class="card" style="padding:28px;border-radius:14px;background:var(--card);">
      <h1>Transactions</h1>
      <p class="muted">All recorded payments will appear here. Click a transaction to see details.</p>

      <div id="tx-list" style="margin-top:18px;display:flex;flex-direction:column;gap:12px"></div>

      <p style="margin-top:18px;"><a href="dashboard.html" class="auth-button">Back to Dashboard</a></p>
    </section>
  </main>

  <script src="api-config.js"></script>
  <script>
    // Auth guard and business approval check
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      window.location.href = 'login.html';
    }

    async function checkApprovalAndLoadBusiness() {
      try {
        const res = await fetch(`${API_BASE}/business/approved/${user.id}`);
        const data = await res.json();
        if (!data.hasApprovedBusiness) {
          alert('You must register and have an approved business before accessing this tool.');
          window.location.href = 'register-business.html';
          return;
        }
      } catch (err) {
        console.error('Error checking approval:', err);
      }
    }

    checkApprovalAndLoadBusiness();

    function fmtNumber(v){ return Number(v).toLocaleString(undefined,{style:'currency',currency:'PHP',maximumFractionDigits:2}); }
    const txList = document.getElementById('tx-list');
    const txs = JSON.parse(localStorage.getItem('transactions')||'[]').slice().reverse();
    if(txs.length===0){ txList.innerHTML = '<p class="muted">No transactions recorded yet.</p>' }
    txs.forEach(tx=>{
      const card = document.createElement('div'); card.className='action-card'; card.style.display='flex'; card.style.flexDirection='column';
        const head = document.createElement('div'); head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center';
        const title = document.createElement('div'); title.innerHTML = `<strong>${tx.id}</strong><div class=\'muted\' style=\'font-size:0.9rem\'>${new Date(tx.createdAt).toLocaleString()}</div>`;
      // right-side wrapper: total plus a fixed-width actions column so button can be
      // consistently positioned at the far-right and vertically centered
      const rightWrap = document.createElement('div'); rightWrap.style.display='flex'; rightWrap.style.alignItems='center'; rightWrap.style.gap='12px';
      const total = document.createElement('div'); total.style.fontWeight='800'; total.textContent = fmtNumber(tx.total);
      // actions container with fixed width to keep the button positioned to the side
      const actionsColumn = document.createElement('div'); actionsColumn.style.minWidth = '160px'; actionsColumn.style.display='flex'; actionsColumn.style.alignItems='center'; actionsColumn.style.justifyContent='center';
      const actions = document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
      const printBtn = document.createElement('button'); printBtn.textContent='Print / Download'; printBtn.className='small-btn warning';
      printBtn.style.whiteSpace = 'nowrap';
      actions.appendChild(printBtn);
      actionsColumn.appendChild(actions);
      rightWrap.appendChild(total); rightWrap.appendChild(actionsColumn);
      head.appendChild(title); head.appendChild(rightWrap);

      const details = document.createElement('div'); details.style.marginTop='8px'; details.style.display='none';
      tx.items.forEach(it=>{
        const r = document.createElement('div'); r.style.display='flex'; r.style.justifyContent='space-between'; r.textContent = `${it.form} â€” ${it.payer||'Unnamed'}`; const a=document.createElement('div'); a.textContent = fmtNumber(it.amount); r.appendChild(a); details.appendChild(r);
      });

      card.appendChild(head); card.appendChild(details);
      card.addEventListener('click', (ev)=>{ 
        // avoid toggling details when clicking the print button
        if(ev.target === printBtn) return;
        details.style.display = details.style.display==='none'?'block':'none';
      });
      // print/download invoice
      printBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); generateInvoice(tx); });
      txList.appendChild(card);
    });

    function generateInvoice(tx){
      const company = 'BIR eServices';
      // build invoice DOM element (not visible) and use html2pdf to download as PDF
      const container = document.createElement('div');
      container.style.maxWidth = '800px';
      container.style.margin = '24px auto';
      container.style.color = '#0f172a';
      container.style.fontFamily = "Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial";
      container.style.padding = '18px';
      container.style.background = '#fff';
      container.style.borderRadius = '6px';
      container.innerHTML = '';

      const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
      const left = document.createElement('div'); const h1 = document.createElement('h1'); h1.textContent='Invoice'; h1.style.margin='0'; left.appendChild(h1); const co = document.createElement('div'); co.textContent = company; left.appendChild(co);
      const right = document.createElement('div'); right.innerHTML = '<strong>Invoice ID:</strong> ' + tx.id + '<br><strong>Date:</strong> ' + new Date(tx.createdAt).toLocaleString();
      header.appendChild(left); header.appendChild(right);

      const table = document.createElement('table'); table.style.width='100%'; table.style.borderCollapse='collapse'; table.style.marginTop='16px';
      const thead = document.createElement('thead'); thead.innerHTML = '<tr><th style="text-align:left;padding:8px;border:1px solid #e6e9ef">Form</th><th style="text-align:left;padding:8px;border:1px solid #e6e9ef">Payer</th><th style="text-align:right;padding:8px;border:1px solid #e6e9ef">Amount</th></tr>';
      table.appendChild(thead);
      const tbody = document.createElement('tbody');
      for(let i=0;i<tx.items.length;i++){
        const it = tx.items[i];
        const tr = document.createElement('tr');
        const td1 = document.createElement('td'); td1.style.padding='8px'; td1.style.border='1px solid #e6e9ef'; td1.textContent = it.form||'';
        const td2 = document.createElement('td'); td2.style.padding='8px'; td2.style.border='1px solid #e6e9ef'; td2.textContent = it.payer||'Unnamed';
        const td3 = document.createElement('td'); td3.style.padding='8px'; td3.style.border='1px solid #e6e9ef'; td3.style.textAlign='right'; td3.textContent = Number(it.amount).toLocaleString(undefined,{style:'currency',currency:'PHP',maximumFractionDigits:2});
        tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tbody.appendChild(tr);
      }
      table.appendChild(tbody);
      const tfoot = document.createElement('tfoot'); tfoot.innerHTML = '<tr><td colspan="2" style="padding:8px;border:1px solid #e6e9ef">Total</td><td style="padding:8px;border:1px solid #e6e9ef;text-align:right">' + Number(tx.total).toLocaleString(undefined,{style:'currency',currency:'PHP',maximumFractionDigits:2}) + '</td></tr>';
      table.appendChild(tfoot);

      const thank = document.createElement('div'); thank.style.marginTop='18px'; thank.textContent = 'Thank you for your payment.';

      container.appendChild(header); container.appendChild(table); container.appendChild(thank);
      // append offscreen then convert
      container.style.position = 'fixed'; container.style.left = '-9999px'; document.body.appendChild(container);

      const opt = {
        margin:       10,
        filename:     tx.id + '.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      // html2pdf returns a Promise-like chain; remove container after save
      try{
        html2pdf().set(opt).from(container).save().then(()=>{ document.body.removeChild(container); }).catch(()=>{ document.body.removeChild(container); alert('Failed to generate PDF.'); });
      }catch(e){ document.body.removeChild(container); alert('PDF generation not available.'); }
    }
  </script>
</body>
</html>