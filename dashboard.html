<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - BIR eServices</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
  <header>
    <nav>
      <a class="logo" href="index.html">
        <img src="assets/logo-icon.svg" alt="BIR" class="logo-icon">
        <img src="assets/logo-text.svg" alt="eServices" class="logo-text">
      </a>
      <div style="flex:1"></div>
      
      <!-- Business Selector (Hidden by default) -->
      <div id="business-selector-container" style="margin-right: 20px; display: none; align-items: center; gap: 10px;">
        <span style="font-size: 0.85rem; font-weight: 600; color: #475569;">Active Business:</span>
        <button id="business-selector-btn" class="glass-btn">Select Business</button>
      </div>

      <div class="user-profile" id="dashboard-user-profile">
        <div id="user-profile-trigger" class="user-profile-info">
            <img id="user-avatar" src="" alt="avatar" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid rgba(0,0,0,0.06);">
            <div style="display:flex;flex-direction:column;align-items:flex-start;margin-left:8px;">
              <div id="dashboard-user-name" style="font-weight:700;color:#081224"></div>
              <div id="dashboard-user-email" style="font-size:0.85rem;color:var(--muted)"></div>
            </div>
        </div>
        <button id="dashboard-logout" class="logout-btn" style="margin-left:14px;">Log Out</button>
      </div>
    </nav>
  </header>

  <main style="max-width:1100px;margin:48px auto;padding:0 24px;">
    <section class="card" style="padding:28px;border-radius:14px;background:var(--card);box-shadow:0 8px 24px rgba(12,18,30,0.04);">
      <h1 id="dashboard-heading">Welcome</h1>
      <p id="dashboard-sub" style="color:var(--muted);margin-top:8px;">This is your personal dashboard where you can see your forms and transactions.</p>

      <div id="dashboard-content" style="margin-top:20px;">
        <!-- Action cards linking to eService tools -->
        <div class="dashboard-actions">
          <a class="menu-card" href="form-sim.html" role="button" tabindex="0" aria-label="Form Simulation">
            <div class="action-icon" aria-hidden="true"><i class="fas fa-file-invoice"></i></div>
            <div class="action-body">
              <h3>Form Simulation</h3>
              <p class="muted">Fill and test BIR forms in a safe simulation environment.</p>
            </div>
          </a>

          <a class="menu-card" href="payments.html" role="button" tabindex="0" aria-label="Payments">
            <div class="action-icon" aria-hidden="true"><i class="fas fa-credit-card"></i></div>
            <div class="action-body">
              <h3>Payments</h3>
              <p class="muted">One Payment â€” manage and process payments for submitted forms.</p>
            </div>
          </a>

          <a class="menu-card" href="transactions.html" role="button" tabindex="0" aria-label="Transactions">
            <div class="action-icon" aria-hidden="true"><i class="fas fa-receipt"></i></div>
            <div class="action-body">
              <h3>Transactions</h3>
              <p class="muted">View and search your payment receipts and transaction history.</p>
            </div>
          </a>

          <a class="menu-card" href="register-business.html" role="button" tabindex="0" aria-label="Register a Business">
            <div class="action-icon" aria-hidden="true"><i class="fas fa-building"></i></div>
            <div class="action-body">
              <h3>Register a Business</h3>
              <p class="muted">Start a business registration process with prefilled forms.</p>
            </div>
          </a>
        </div>
      </div>
    </section>
  </main>

  <!-- Business Selection Modal -->
  <div id="business-modal" class="modal-overlay">
    <div class="modal-content glass-panel">
      <div class="modal-header">
        <h2>Select Business</h2>
        <button id="close-modal" class="close-btn">&times;</button>
      </div>
      <div id="business-list" class="business-list">
        <!-- Items injected here -->
      </div>
    </div>
  </div>

  <script src="api-config.js"></script>
  <script>
    // Auth guard and populate user info
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      // Not logged in â€” redirect to login page
      window.location.href = 'login.html';
    } else {
      document.getElementById('dashboard-heading').textContent = `Hello, ${user.firstName}`;
      document.getElementById('dashboard-user-name').textContent = `${user.firstName} ${user.lastName || ''}`;
      document.getElementById('dashboard-user-email').textContent = user.email;

      // Simple default avatar using initials if no avatar URL
      const avatarEl = document.getElementById('user-avatar');
      const initials = (user.firstName || '').charAt(0).toUpperCase() + (user.lastName || '').charAt(0).toUpperCase();
      // Create a data URL with SVG if you want a built-in avatar
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect width='100%' height='100%' fill='#e6eefb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Inter, system-ui, sans-serif' font-size='32' fill='#0b1220'>${initials}</text></svg>`;
      avatarEl.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);

      // Logout handler
      document.getElementById('dashboard-logout').addEventListener('click', () => {
        localStorage.removeItem('user');
        window.location.href = 'index.html';
      });

      // Check if user has approved business
      async function loadBusinesses() {
        try {
          const res = await fetch(`${API_BASE}/businesses?ownerId=${user.id}`);
          const data = await res.json();
          const businesses = data.businesses || [];
          
          // Filter approved ones
          const approvedBusinesses = businesses.filter(b => b.status === 'APPROVED');
          
          if (approvedBusinesses.length === 0) {
            lockTools();
            localStorage.removeItem('activeBusiness');
          } else {
            setupBusinessSelector(approvedBusinesses);
          }
        } catch (err) {
          console.error('Error loading businesses:', err);
        }
      }

      function lockTools() {
        const actionCards = document.querySelectorAll('.menu-card');
        actionCards.forEach(card => {
          const text = card.innerText;
          // Lock all except "Register a Business"
          if (!text.includes('Register a Business')) {
            card.style.opacity = '0.5';
            card.style.pointerEvents = 'none';
            card.style.cursor = 'not-allowed';
            card.style.position = 'relative';
            
            // Add overlay message
            const overlay = document.createElement('div');
            overlay.style.position = 'absolute';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.right = '0';
            overlay.style.bottom = '0';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
            overlay.style.borderRadius = '8px';
            overlay.style.fontSize = '0.85rem';
            overlay.style.fontWeight = '600';
            overlay.style.color = '#e63946';
            overlay.style.textAlign = 'center';
            overlay.style.padding = '16px';
            overlay.innerHTML = 'ðŸ”’ Register a business first to unlock this tool';
            card.style.position = 'relative';
            card.appendChild(overlay);
          }
        });
      }

      function setupBusinessSelector(businesses) {
        const container = document.getElementById('business-selector-container');
        const btn = document.getElementById('business-selector-btn');
        const modal = document.getElementById('business-modal');
        const closeBtn = document.getElementById('close-modal');
        const list = document.getElementById('business-list');
        
        // Determine active business
        let activeBusiness = JSON.parse(localStorage.getItem('activeBusiness'));
        
        // Verify if stored active business still exists and is approved
        if (activeBusiness) {
            const stillExists = businesses.find(b => b.id === activeBusiness.id);
            if (!stillExists) activeBusiness = null;
        }

        // Default to first if none selected
        if (!activeBusiness) {
            activeBusiness = businesses[0];
            localStorage.setItem('activeBusiness', JSON.stringify(activeBusiness));
        }

        // Update button text
        btn.textContent = activeBusiness.businessName;

        if (businesses.length > 1) {
            // Show selector
            container.style.display = 'flex';
            
            // Open Modal
            btn.addEventListener('click', () => {
                modal.classList.add('active');
                renderList();
            });

            // Close Modal
            closeBtn.addEventListener('click', () => modal.classList.remove('active'));
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('active');
            });

            function renderList() {
                list.innerHTML = '';
                businesses.forEach(b => {
                    const item = document.createElement('div');
                    item.className = `business-item ${b.id === activeBusiness.id ? 'active' : ''}`;
                    item.innerHTML = `
                        <div class="business-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="business-info">
                            <div class="business-name">${b.businessName}</div>
                            <div class="business-type">${b.registrationType === 'INDIVIDUAL' ? 'Individual' : 'Non-Individual'}</div>
                        </div>
                        ${b.id === activeBusiness.id ? '<i class="fas fa-check" style="color:var(--accent-1)"></i>' : ''}
                    `;
                    item.addEventListener('click', () => {
                        activeBusiness = b;
                        localStorage.setItem('activeBusiness', JSON.stringify(b));
                        btn.textContent = b.businessName;
                        modal.classList.remove('active');
                        // Visual feedback
                        // alert(`Active business switched to: ${b.businessName}`);
                    });
                    list.appendChild(item);
                });
            }

        } else {
            // Only 1 business, hide selector but ensure it's set as active
            container.style.display = 'none';
            localStorage.setItem('activeBusiness', JSON.stringify(businesses[0]));
        }
      }

      loadBusinesses();
    }
  </script>
  <!-- User Profile Modal -->
  <div id="profile-modal" class="modal-overlay">
    <div class="glass-panel" style="width: 100%; max-width: 480px;">
      <div class="modal-header">
        <h2>User Profile</h2>
        <button id="close-profile-modal" class="close-btn">&times;</button>
      </div>
      
      <div style="display:flex; flex-direction:column; gap:16px;">
        <div>
            <label style="display:block;font-weight:600;margin-bottom:4px;">Full Name</label>
            <input id="profile-name" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.1);background:rgba(255,255,255,0.5);" />
        </div>
        
        <div>
            <label style="display:block;font-weight:600;margin-bottom:4px;">TIN</label>
            <input id="profile-tin" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.1);background:rgba(255,255,255,0.5);" />
        </div>

        <div>
            <label style="display:block;font-weight:600;margin-bottom:4px;">Email Address</label>
            <input id="profile-email" disabled style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.1);background:rgba(0,0,0,0.05);color:var(--muted);" />
        </div>

        <div style="margin-top:8px; padding-top:16px; border-top:1px solid rgba(0,0,0,0.05);">
            <button id="reset-password-btn" class="small-btn" style="width:100%; justify-content:center;">Reset Password</button>
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px;padding-top:16px;border-top:1px solid rgba(0,0,0,0.05);">
        <button id="profile-cancel" class="signup-btn" style="background:rgba(255,255,255,0.5);">Cancel</button>
        <button id="profile-save" class="auth-button">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    // User Profile Modal Logic
    const profileTrigger = document.getElementById('user-profile-trigger');
    const profileModal = document.getElementById('profile-modal');
    const closeProfileModal = document.getElementById('close-profile-modal');
    const profileCancel = document.getElementById('profile-cancel');
    const profileSave = document.getElementById('profile-save');
    const resetPasswordBtn = document.getElementById('reset-password-btn');

    const profileNameInput = document.getElementById('profile-name');
    const profileTinInput = document.getElementById('profile-tin');
    const profileEmailInput = document.getElementById('profile-email');

    if (profileTrigger) {
        profileTrigger.addEventListener('click', () => {
            // Load current user data
            const currentUser = JSON.parse(localStorage.getItem('user'));
            if (currentUser) {
                profileNameInput.value = currentUser.fullName || '';
                profileTinInput.value = currentUser.tin || '';
                profileEmailInput.value = currentUser.email || '';
                profileModal.classList.add('active');
            }
        });
    }

    function closeProfile() {
        profileModal.classList.remove('active');
    }

    if (closeProfileModal) closeProfileModal.addEventListener('click', closeProfile);
    if (profileCancel) profileCancel.addEventListener('click', closeProfile);
    if (profileModal) {
        profileModal.addEventListener('click', (e) => {
            if (e.target === profileModal) closeProfile();
        });
    }

    if (profileSave) {
        profileSave.addEventListener('click', () => {
            const currentUser = JSON.parse(localStorage.getItem('user'));
            if (currentUser) {
                currentUser.fullName = profileNameInput.value;
                currentUser.tin = profileTinInput.value;
                
                // Update localStorage
                localStorage.setItem('user', JSON.stringify(currentUser));
                
                // Update UI
                document.getElementById('dashboard-user-name').textContent = currentUser.fullName;
                
                // Visual feedback
                alert('Profile updated successfully!');
                closeProfile();
            }
        });
    }

    if (resetPasswordBtn) {
        resetPasswordBtn.addEventListener('click', () => {
            if(confirm('Are you sure you want to reset your password? An email will be sent to ' + profileEmailInput.value)) {
                alert('Password reset link sent!');
            }
        });
    }
  </script>
<script src='loader.js'></script>
</body>
</html>
