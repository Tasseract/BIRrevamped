<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard - BIR eServices</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
  <header>
    <nav>
      <a class="logo" href="index.html">BIR eServices</a>
      <div style="flex:1"></div>
      
      <!-- Business Selector (Hidden by default) -->
      <div id="business-selector-container" style="margin-right: 20px; display: none;">
        <select id="business-selector" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-size: 0.9rem; max-width: 200px;">
        </select>
      </div>

      <div class="user-profile" id="dashboard-user-profile">
        <img id="user-avatar" src="" alt="avatar" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:1px solid rgba(0,0,0,0.06);">
        <div style="display:flex;flex-direction:column;align-items:flex-start;margin-left:8px;">
          <div id="dashboard-user-name" style="font-weight:700;color:#081224"></div>
          <div id="dashboard-user-email" style="font-size:0.85rem;color:var(--muted)"></div>
        </div>
        <button id="dashboard-logout" class="logout-btn" style="margin-left:14px;">Log Out</button>
      </div>
    </nav>
  </header>

  <main style="max-width:1100px;margin:48px auto;padding:0 24px;">
    <section class="card" style="padding:28px;border-radius:14px;background:var(--card);box-shadow:0 8px 24px rgba(12,18,30,0.04);">
      <h1 id="dashboard-heading">Welcome</h1>
      <p id="dashboard-sub" style="color:var(--muted);margin-top:8px;">This is your personal dashboard where you can see your forms and transactions.</p>

      <div id="dashboard-content" style="margin-top:20px;">
        <!-- Action cards linking to eService tools -->
        <div class="dashboard-actions">
          <a class="menu-card" href="form-sim.html" role="button" tabindex="0" aria-label="Form Simulation">
            <div class="action-icon" aria-hidden="true"><i class="fas fa-file-invoice"></i></div>
            <div class="action-body">
              <h3>Form Simulation</h3>
              <p class="muted">Fill and test BIR forms in a safe simulation environment.</p>
            </div>
          </a>

          <a class="menu-card" href="payments.html" role="button" tabindex="0" aria-label="Payments">
            <div class="action-icon" aria-hidden="true"><i class="fas fa-credit-card"></i></div>
            <div class="action-body">
              <h3>Payments</h3>
              <p class="muted">One Payment â€” manage and process payments for submitted forms.</p>
            </div>
          </a>

          <a class="menu-card" href="transactions.html" role="button" tabindex="0" aria-label="Transactions">
            <div class="action-icon" aria-hidden="true"><i class="fas fa-receipt"></i></div>
            <div class="action-body">
              <h3>Transactions</h3>
              <p class="muted">View and search your payment receipts and transaction history.</p>
            </div>
          </a>

          <a class="menu-card" href="register-business.html" role="button" tabindex="0" aria-label="Register a Business">
            <div class="action-icon" aria-hidden="true"><i class="fas fa-building"></i></div>
            <div class="action-body">
              <h3>Register a Business</h3>
              <p class="muted">Start a business registration process with prefilled forms.</p>
            </div>
          </a>
        </div>
      </div>
    </section>
  </main>

  <script src="api-config.js"></script>
  <script>
    // Auth guard and populate user info
    const user = JSON.parse(localStorage.getItem('user'));
    if (!user) {
      // Not logged in â€” redirect to login page
      window.location.href = 'login.html';
    } else {
      document.getElementById('dashboard-heading').textContent = `Hello, ${user.firstName}`;
      document.getElementById('dashboard-user-name').textContent = `${user.firstName} ${user.lastName || ''}`;
      document.getElementById('dashboard-user-email').textContent = user.email;

      // Simple default avatar using initials if no avatar URL
      const avatarEl = document.getElementById('user-avatar');
      const initials = (user.firstName || '').charAt(0).toUpperCase() + (user.lastName || '').charAt(0).toUpperCase();
      // Create a data URL with SVG if you want a built-in avatar
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='80' height='80'><rect width='100%' height='100%' fill='#e6eefb'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Inter, system-ui, sans-serif' font-size='32' fill='#0b1220'>${initials}</text></svg>`;
      avatarEl.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);

      // Logout handler
      document.getElementById('dashboard-logout').addEventListener('click', () => {
        localStorage.removeItem('user');
        window.location.href = 'index.html';
      });

      // Check if user has approved business
      async function loadBusinesses() {
        try {
          const res = await fetch(`${API_BASE}/businesses?ownerId=${user.id}`);
          const data = await res.json();
          const businesses = data.businesses || [];
          
          // Filter approved ones
          const approvedBusinesses = businesses.filter(b => b.status === 'APPROVED');
          
          if (approvedBusinesses.length === 0) {
            lockTools();
            localStorage.removeItem('activeBusiness');
          } else {
            setupBusinessSelector(approvedBusinesses);
          }
        } catch (err) {
          console.error('Error loading businesses:', err);
        }
      }

      function lockTools() {
        const actionCards = document.querySelectorAll('.menu-card');
        actionCards.forEach(card => {
          const text = card.innerText;
          // Lock all except "Register a Business"
          if (!text.includes('Register a Business')) {
            card.style.opacity = '0.5';
            card.style.pointerEvents = 'none';
            card.style.cursor = 'not-allowed';
            card.style.position = 'relative';
            
            // Add overlay message
            const overlay = document.createElement('div');
            overlay.style.position = 'absolute';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.right = '0';
            overlay.style.bottom = '0';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
            overlay.style.borderRadius = '8px';
            overlay.style.fontSize = '0.85rem';
            overlay.style.fontWeight = '600';
            overlay.style.color = '#e63946';
            overlay.style.textAlign = 'center';
            overlay.style.padding = '16px';
            overlay.innerHTML = 'ðŸ”’ Register a business first to unlock this tool';
            card.style.position = 'relative';
            card.appendChild(overlay);
          }
        });
      }

      function setupBusinessSelector(businesses) {
        const container = document.getElementById('business-selector-container');
        const selector = document.getElementById('business-selector');
        
        // Determine active business
        let activeBusiness = JSON.parse(localStorage.getItem('activeBusiness'));
        
        // Verify if stored active business still exists and is approved
        if (activeBusiness) {
            const stillExists = businesses.find(b => b.id === activeBusiness.id);
            if (!stillExists) activeBusiness = null;
        }

        // Default to first if none selected
        if (!activeBusiness) {
            activeBusiness = businesses[0];
            localStorage.setItem('activeBusiness', JSON.stringify(activeBusiness));
        }

        if (businesses.length > 1) {
            // Show selector
            container.style.display = 'block';
            selector.innerHTML = '';
            businesses.forEach(b => {
                const option = document.createElement('option');
                option.value = b.id;
                option.textContent = b.businessName;
                if (b.id === activeBusiness.id) option.selected = true;
                selector.appendChild(option);
            });

            selector.addEventListener('change', (e) => {
                const selectedId = e.target.value;
                const selected = businesses.find(b => b.id === selectedId);
                localStorage.setItem('activeBusiness', JSON.stringify(selected));
                // Visual feedback
                alert(`Active business switched to: ${selected.businessName}`);
            });
        } else {
            // Only 1 business, hide selector but ensure it's set as active
            container.style.display = 'none';
            localStorage.setItem('activeBusiness', JSON.stringify(businesses[0]));
        }
      }

      loadBusinesses();
    }
  </script>
<script src='loader.js'></script>
</body>
</html>
