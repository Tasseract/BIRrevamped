<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin Dashboard - BIR eServices</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header>
    <nav>
      <a class="logo" href="index.html">
        <img src="assets/logo-icon.svg" alt="BIR" class="logo-icon">
        <img src="assets/logo-text.svg" alt="eServices" class="logo-text">
      </a>
      <div style="margin-left:auto;display:flex;gap:12px;align-items:center">
        <button id="admin-logout" class="signup-btn">Log out</button>
      </div>
    </nav>
  </header>

  <main style="max-width:1200px;margin:28px auto;padding:0 18px;">
    <section class="card" style="padding:20px;border-radius:12px;">
      <h1>Admin Dashboard</h1>
      <p class="muted">Manage users and approve/reject registered businesses.</p>

      <div style="display:grid;grid-template-columns:350px 1fr;gap:24px;margin-top:24px">
        <!-- Left Column: Users -->
        <div style="border-right: 1px solid #eee; padding-right: 24px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3>Users</h3>
          </div>
          <input type="text" id="user-search" placeholder="Search users..." style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:6px;margin-bottom:12px">
          <div id="user-list" style="display:flex;flex-direction:column;gap:8px;max-height:600px;overflow-y:auto"></div>
        </div>

        <!-- Right Column: Businesses / Details -->
        <div>
          <div id="user-details-panel" style="display:none;background:#f8fafc;padding:16px;border-radius:8px;margin-bottom:20px;border:1px solid #e2e8f0">
            <div style="display:flex;justify-content:space-between;align-items:start">
                <div>
                    <h3 id="selected-user-name" style="margin:0 0 4px 0">User Name</h3>
                    <div id="selected-user-info" class="muted" style="font-size:0.9rem"></div>
                </div>
                <button id="clear-selection-btn" class="small-btn" style="background:#fff;border:1px solid #ddd">View All</button>
            </div>
          </div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h3 id="business-section-title">All Businesses</h3>
            <select id="status-filter" style="padding:6px 12px;border-radius:6px;border:1px solid #ddd">
                <option value="ALL">All Statuses</option>
                <option value="PENDING">Pending</option>
                <option value="APPROVED">Approved</option>
                <option value="REJECTED">Rejected</option>
            </select>
          </div>
          
          <div id="biz-list" style="display:flex;flex-direction:column;gap:12px"></div>
        </div>
      </div>
    </section>
  </main>

  <script src="api-config.js"></script>
  <script>
    // simple admin guard
    const admin = JSON.parse(localStorage.getItem('admin')||'null');
    if(!admin){ window.location.href = 'admin-login.html'; }

    document.getElementById('admin-logout').addEventListener('click', ()=>{
      localStorage.removeItem('admin');
      window.location.href = 'admin-login.html';
    });

    let allUsers = [];
    let allBusinesses = [];
    let selectedUserId = null;

    // Event Listeners
    document.getElementById('user-search').addEventListener('input', (e) => {
        renderUsers(e.target.value);
    });

    document.getElementById('status-filter').addEventListener('change', () => {
        renderBusinesses();
    });

    document.getElementById('clear-selection-btn').addEventListener('click', clearUserSelection);

    async function fetchData(){
      if (typeof API_BASE === 'undefined') {
        alert('API configuration missing.');
        return;
      }
      try{
        console.log('Fetching admin data from', API_BASE);
        const [usersRes, bizRes] = await Promise.all([
          fetch(`${API_BASE}/admin/users`),
          fetch(`${API_BASE}/admin/businesses`)
        ]);
        const usersJson = await usersRes.json();
        const bizJson = await bizRes.json();
        
        allUsers = usersJson.users || [];
        allBusinesses = bizJson.businesses || [];
        
        renderUsers();
        renderBusinesses();
      }catch(err){ console.error(err); alert('Error fetching admin data. Check server.'); }
    }

    function renderUsers(searchTerm = '') {
      const el = document.getElementById('user-list'); 
      el.innerHTML='';
      
      // Sort alphabetically by Last Name, then First Name
      let users = [...allUsers].sort((a, b) => {
          const nameA = (a.lastName + a.firstName).toLowerCase();
          const nameB = (b.lastName + b.firstName).toLowerCase();
          return nameA.localeCompare(nameB);
      });

      // Filter by search
      if (searchTerm) {
          const term = searchTerm.toLowerCase();
          users = users.filter(u => 
              u.firstName.toLowerCase().includes(term) || 
              u.lastName.toLowerCase().includes(term) || 
              u.email.toLowerCase().includes(term) ||
              u.tin.includes(term)
          );
      }

      if(users.length===0){ el.innerHTML='<p class="muted">No users found.</p>'; return }

      users.forEach(u => {
        const card = document.createElement('div');
        card.className = 'action-card user-card';
        if (selectedUserId === u.id) {
            card.style.border = '2px solid #0066ff';
            card.style.background = '#f0f7ff';
        }
        card.style.cursor = 'pointer';
        card.style.padding = '12px';
        
        card.innerHTML = `
            <div style="font-weight:600">${u.firstName} ${u.lastName}</div>
            <div class='muted' style='font-size:0.85rem'>${u.email}</div>
            <div class='muted' style='font-size:0.8rem'>TIN: ${u.tin}</div>
        `;
        
        card.addEventListener('click', () => selectUser(u));
        el.appendChild(card);
      });
    }

    function selectUser(user) {
        selectedUserId = user.id;
        
        // Update User Details Panel
        document.getElementById('user-details-panel').style.display = 'block';
        document.getElementById('selected-user-name').textContent = `${user.firstName} ${user.lastName}`;
        document.getElementById('selected-user-info').innerHTML = `
            Email: ${user.email}<br>
            TIN: ${user.tin}<br>
            User ID: ${user.id}
        `;
        
        document.getElementById('business-section-title').textContent = `${user.firstName}'s Businesses`;
        
        // Re-render lists
        renderUsers(document.getElementById('user-search').value);
        renderBusinesses();
    }

    function clearUserSelection() {
        selectedUserId = null;
        document.getElementById('user-details-panel').style.display = 'none';
        document.getElementById('business-section-title').textContent = 'All Businesses';
        renderUsers(document.getElementById('user-search').value);
        renderBusinesses();
    }

    function renderBusinesses(){
      const el = document.getElementById('biz-list'); 
      el.innerHTML='';
      
      let businesses = [...allBusinesses];
      
      // Filter by User
      if (selectedUserId) {
          businesses = businesses.filter(b => b.userId === selectedUserId);
      }
      
      // Filter by Status
      const statusFilter = document.getElementById('status-filter').value;
      if (statusFilter !== 'ALL') {
          businesses = businesses.filter(b => b.status === statusFilter);
      }

      if(businesses.length===0){ 
          el.innerHTML=`<div style="text-align:center;padding:20px;color:#64748b;background:#f8fafc;border-radius:8px">
            No ${statusFilter !== 'ALL' ? statusFilter.toLowerCase() : ''} businesses found${selectedUserId ? ' for this user' : ''}.
          </div>`; 
          return 
      }

      businesses.forEach(b=>{
        const row = document.createElement('div'); 
        row.className='action-card'; 
        row.style.display='flex'; 
        row.style.flexDirection='column'; 
        row.style.gap='12px';
        
        const statusBadgeColor = b.status === 'APPROVED' ? '#28a745' : b.status === 'REJECTED' ? '#e63946' : '#ffc107';
        const statusBadgeTextColor = b.status === 'APPROVED' ? '#fff' : b.status === 'REJECTED' ? '#fff' : '#000';
        
        const header = document.createElement('div'); 
        header.style.display='flex'; 
        header.style.justifyContent='space-between'; 
        header.style.alignItems='center';
        let detailsHtml = `
          <div style="font-weight:700;font-size:1.05rem">${b.businessName}</div>
          <div class='muted' style='font-size:0.9rem;margin-top:4px'>
            <strong>TIN:</strong> ${b.businessTin}<br>
            <strong>Type:</strong> ${b.registrationType || 'N/A'}<br>
            <strong>Line of Business:</strong> ${b.lineOfBusiness || 'N/A'}<br>
            <strong>Address:</strong> ${b.businessAddress || 'N/A'}<br>
            <strong>Contact:</strong> ${b.businessContact || 'N/A'} • ${b.businessEmail || 'N/A'}<br>
        `;

        if (b.registrationType === 'INDIVIDUAL') {
            detailsHtml += `
                <div style="margin-top:4px; padding-top:4px; border-top:1px dashed #ccc;">
                    <strong>Owner:</strong> ${b.ownerName} (TIN: ${b.ownerTin})<br>
                    <strong>Civil Status:</strong> ${b.civilStatus || 'N/A'} • <strong>Citizenship:</strong> ${b.citizenship || 'N/A'}
                </div>
            `;
        } else if (b.registrationType === 'NON_INDIVIDUAL') {
            detailsHtml += `
                <div style="margin-top:4px; padding-top:4px; border-top:1px dashed #ccc;">
                    <strong>Org Type:</strong> ${b.organizationType || 'N/A'}<br>
                    <strong>SEC/CDA No:</strong> ${b.secRegNum || 'N/A'}<br>
                    <strong>Auth Rep:</strong> ${b.authorizedRep || 'N/A'}
                </div>
            `;
        }

        detailsHtml += `</div>`;

        header.innerHTML = `
          <div style="flex:1">
            ${detailsHtml}
          </div>
          <div style="padding:6px 12px;border-radius:6px;background:${statusBadgeColor};color:${statusBadgeTextColor};font-weight:600;font-size:0.85rem;white-space:nowrap;margin-left:12px">
            ${b.status}
          </div>
        `;
        
        const controls = document.createElement('div'); 
        controls.style.display='flex'; 
        controls.style.gap='8px';
        controls.style.justifyContent='flex-end';
        
        const approve = document.createElement('button'); 
        approve.textContent='Approve'; 
        approve.className='small-btn primary'; 
        approve.type='button';
        approve.disabled = b.status === 'APPROVED';
        
        const reject = document.createElement('button'); 
        reject.textContent='Reject'; 
        reject.className='small-btn danger'; 
        reject.type='button';
        reject.disabled = b.status === 'REJECTED';
        
        approve.addEventListener('click', async ()=>{
          try{
            const r = await fetch(`${API_BASE}/business/`+b.id,{ 
              method:'PATCH', 
              headers:{'Content-Type':'application/json'}, 
              body: JSON.stringify({ status: 'APPROVED' }) 
            });
            const body = await r.json(); 
            if(!r.ok) throw new Error(body.message||'Error'); 
            alert('Business approved successfully!'); 
            fetchData();
          }catch(err){ console.error(err); alert('Error updating business'); }
        });
        
        reject.addEventListener('click', async ()=>{
          try{
            const r = await fetch(`${API_BASE}/business/`+b.id,{ 
              method:'PATCH', 
              headers:{'Content-Type':'application/json'}, 
              body: JSON.stringify({ status: 'REJECTED' }) 
            });
            const body = await r.json(); 
            if(!r.ok) throw new Error(body.message||'Error'); 
            alert('Business rejected'); 
            fetchData();
          }catch(err){ console.error(err); alert('Error updating business'); }
        });
        
        controls.appendChild(approve); 
        controls.appendChild(reject);
        row.appendChild(header); 
        row.appendChild(controls); 
        el.appendChild(row);
      });
    }

    fetchData();
  </script>
</body>
</html>
